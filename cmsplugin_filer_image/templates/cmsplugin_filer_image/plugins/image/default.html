{% load thumbnail filer_tags filer_image_tags staticfiles sekizai_tags %}
{% comment %}
    Added the image alignment to the caption class too

	You may change the image size for special cases in your project by overriding
	this template. There are a few size manipulation filters for this in
	`filer_image_tags`:

	{% if placeholder == 'my_special_sidebar' %}
		{% thumbnail instance.image opts.size|extra_padding_y:10 crop=opts.crop upscale=opts.upscale as thumbnail %}
	{% else %}
		{% thumbnail instance.image opts.size crop=opts.crop upscale=opts.upscale as thumbnail %}
	{% endif %}
	{% if link %}<a href="{{ link }}"{% if instance.target_blank %} target="_blank"{% endif %} {{ instance.link_attributes_str }}>{% endif %}<img{% if instance.alignment %} class="{{ instance.alignment }}"{% endif %} alt="{% if instance.alt %}{{ instance.alt }}{% endif %}" src="{{ thumbnail.url }}"{% if instance.caption %} title="{{ instance.caption }}"{% endif %} />{% if link %}</a>{% endif %}
{% endcomment %}

{% addtoblock "js" %}
    {% if instance.popup_image and not link %}
        <script src="{% static 'cmsplugin_filer_image/ext-plugins/magnific-popup/1.1.0/js/magnific-popup.min.js' %}"></script>
    {% endif %}
{% endaddtoblock %}

{% addtoblock "css" %}
    {% if instance.popup_image and not link %}
        <link rel="stylesheet" href="{% static 'cmsplugin_filer_image/ext-plugins/magnific-popup/1.1.0/css/magnific-popup.min.css' %}"/>
    {% endif %}
{% endaddtoblock %}

{% addtoblock "js" %}
    {% if not request.toolbar.edit_mode and instance.popup_image and not link %}
        <script>
            $(document).ready(function () {
                $('#mfp-image-{{ instance.id }}').magnificPopup(
                    {
                        items: {
                            src: '{{ instance.image.url }}'
                        },
                        type: 'image'});
            });
        </script>
    {% endif %}
{% endaddtoblock %}

{% spaceless %}
    <figure class="figure">
        {# -- Link -- #}
        {% if link %}<a href="{{ link }}"{% if instance.target_blank %} target="_blank"{% endif %} class="filer_image_link" {{ instance.link_attributes_str }}>{% endif %}

        {# -- Image -- #}
        {% if instance.image %}
            {% if instance.use_original_image %}
                <img id="mfp-image-{{ instance.id }}"
                    class="filer_image {% if instance.alignment %}block-{{ instance.alignment }}{% endif %}{% if instance.use_autoscale %} img-responsive{% endif %}"
                     alt="{% if instance.alt %}{{ instance.alt }}{% endif %}"
                     src="{{ instance.image.url }}"
                    {% if instance.width %}width="{{ instance.width }}"{% endif %}
                    {% if instance.height %}height="{{ instance.height }}"{% endif %}
                    {% if instance.caption %}title="{{ instance.caption }}"{% endif %} />
            {% else %}
                {% thumbnail instance.image size crop=opts.crop upscale=opts.upscale subject_location=opts.subject_location as thumbnail %}
                <img id="mfp-image-{{ instance.id }}"
                     class="filer_image {% if instance.alignment %}block-{{ instance.alignment }}{% endif %}{% if instance.use_autoscale %} img-responsive{% endif %}"
                     alt="{% if instance.alt %}{{ instance.alt }}{% endif %}"
                     src="{{ thumbnail.url }}"
                    {% if instance.width %}width="{{ instance.width }}"{% endif %}
                    {% if instance.height %}height="{{ instance.height }}"{% endif %}
                    {% if instance.caption %}title="{{ instance.caption }}"{% endif %} />
            {% endif %}
        {% else %}
            {# just a plain link to some external image #}
            <img id="mfp-image-{{ instance.id }}"
                 class="filer_image {% if instance.alignment %}block-{{ instance.alignment }}{% endif %}{% if instance.use_autoscale %} img-responsive{% endif %}"
                 alt="{% if instance.alt %}{{ instance.alt }}{% endif %}"
                 src="{{ instance.image_url }}"
                {% if size.0 %}width="{{ size.0 }}"{% endif %}
                {% if size.1 %}height="{{ size.1 }}"{% endif %}
                {% if instance.caption %}title="{{ instance.caption }}"{% endif %} />
        {% endif %}
        {% if link %}</a>{% endif %}

        {# -- Caption -- #}
        {% if instance.caption or instance.description %}
            {#  removed classes: filer_image_info#}
            <figcaption class="figure-caption {% if instance.alignment %}block-{{ instance.alignment }}{% endif %}"
                        {% if instance.width %}style="max-width:{{ instance.width }}px" {% endif %}>
                {% if instance.caption %}<p class="title {% if instance.description %}title_and_desc{% endif %}">{{ instance.caption }}</p>{% endif %}
                {% if instance.description %}<p class="desc">{{ instance.description|linebreaks }}</p>{% endif %}
            </figcaption>
        {% endif %}

    </figure>
{% endspaceless %}
